<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testimonial Consent Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-red: #c53e5c;
            --secondary-red: #a8334a;
            --light-red: #f8e8ec;
            --dark-gray: #2d3748;
            --medium-gray: #718096;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --success-green: #48bb78;
            --warning-orange: #ed8936;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9f9f3;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-red), var(--secondary-red));
            color: var(--white);
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px 30px;
        }

        .procedure-info {
            background: var(--light-red);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border-left: 5px solid var(--primary-red);
        }

        .procedure-info h2 {
            color: var(--primary-red);
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .procedure-info ul {
            list-style: none;
            padding-left: 0;
        }

        .procedure-info li {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .procedure-info li::before {
            content: '✓';
            color: var(--success-green);
            font-weight: bold;
            margin-top: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-group.full-width {
                grid-column: 1 / -1;
            }
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--dark-gray);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group label .icon {
            color: var(--medium-gray);
            font-size: 16px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(197, 62, 92, 0.1);
        }

        .form-group input:valid {
            border-color: var(--success-green);
        }

        .checkbox-group {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .checkbox-item:hover {
            background: var(--light-red);
            border-color: var(--primary-red);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
        }

        .signature-section {
            margin-top: 24px;
        }

        .signature-container {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: var(--transition);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .signature-controls {
            margin-top: 15px;
            display: none;
            width: 100%;
            text-align: center;
        }

        @media (min-width: 768px) {
            .signature-container {
                align-items: center;
                justify-content: center;
            }
            
            .signature-controls {
                display: none;
                justify-content: center;
                width: auto;
            }
        }

        .signature-container:hover {
            border-color: var(--primary-red);
            background: var(--light-red);
        }

        .signature-placeholder {
            color: var(--medium-gray);
            font-size: 14px;
        }

        .signature-canvas {
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            cursor: crosshair;
            background: var(--white);
            display: none;
            width: 100%;       
            max-width: 400px;   
            height: 150px;
            margin-bottom: 10px;
        }

        .mobile-signature-hint {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #1976d2;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--secondary-red));
            color: var(--white);
            box-shadow: 0 4px 15px rgba(197, 62, 92, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(197, 62, 92, 0.4);
        }

        .btn-secondary {
            background: var(--medium-gray);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--dark-gray);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-1px);
        }

        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            margin-top: 40px;
            padding-top: 32px;
            border-top: 2px solid var(--light-gray);
        }

        @media (min-width: 640px) {
            .form-actions {
                flex-direction: row;
                justify-content: center;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            transform: scale(0.8);
            transition: var(--transition);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--success-green), #38a169);
            color: var(--white);
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .modal-header.error {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: var(--white);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
            opacity: 0.8;
        }

        .modal-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            text-align: center;
        }

        .modal-body p {
            color: var(--medium-gray);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid var(--light-gray);
        }

        .modal-footer .btn {
            min-width: 120px;
        }

        .success-icon {
            width: 60px;
            height: 60px;
            background: var(--success-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: var(--white);
            font-size: 24px;
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .btn-download {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: var(--white);
            border: none;
        }

        .btn-download:hover {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            transform: translateY(-1px);
        }

        .section-title {
            color: var(--primary-red);
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-red);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .clinician-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            border-left: 5px solid #2196f3;
        }

        .consent-sections {
            margin-bottom: 30px;
        }

        .consent-section {
            background: var(--light-gray);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-red);
        }

        .consent-section h2 {
            color: var(--primary-red);
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consent-section ul {
            list-style: none;
            padding-left: 0;
        }

        .consent-section li {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .consent-section li::before {
            content: '✓';
            color: var(--success-green);
            font-weight: bold;
            margin-top: 2px;
        }

        @media print {
          .header {
              background: #c53e5c !important;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
          }
          
          .consent-section {
              break-inside: avoid;
          }
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Consent Form for Testimonial and Educational Use</h1>
        </div>

        <div class="content">
                        
            <div class="form-container">
                <form id="consentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="patientName">
                                <i class="fas fa-user icon"></i>
                                Patient Name
                            </label>
                            <input type="text" id="patientName" name="patientName" required placeholder="Enter your full name">
                        </div>

                                                
                        <div class="form-group">
                            <label for="contactNo">
                                <i class="fas fa-phone icon"></i>
                                Contact No.
                            </label>
                              <input type="tel" id="contactNo" name="contactNo" required placeholder="Enter your contact number" pattern="[0-9+\-\s]+" oninput="this.value = this.value.replace(/[^0-9+\-\s]/g, '')" title="Only numbers, +, -, and spaces are allowed">
                        </div>

                        <div class="form-group full-width">
                            <label for="patientEmail">
                                <i class="fas fa-envelope icon"></i>
                                Email Address
                            </label>
                            <input type="email" id="patientEmail" name="patientEmail" required placeholder="Enter your email address">
                            <small style="color: var(--medium-gray); font-size: 12px; margin-top: 5px; display: block;">
                                A copy of the consent form will be sent to this email
                            </small>
                        </div>
                    </div>
                    </div>

                    <div class="consent-section" style="margin: 30px 0; padding: 25px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid var(--primary-red);">
                        <div class="section-title" style="display: flex; align-items: center; margin-bottom: 20px; font-size: 18px; font-weight: 600; color: var(--primary-red);">
                            <i class="fas fa-video" style="margin-right: 10px;"></i>
                            Purpose
                        </div>
                        
                        <div class="purpose-section" style="margin-bottom: 25px;">
                            <p style="color: var(--medium-gray); line-height: 1.6;">
                                This consent form is to confirm that I, the undersigned, voluntarily agree to provide my testimonial 
                                regarding treatment with K-Laser. I understand that my testimonial may be used by Photomedic 
                                Solutions Sdn Bhd for educational, promotional, and marketing purposes.
                            </p>
                        </div>

                        <div class="media-consent-section" style="margin-bottom: 25px;">
                            <h4 style="color: var(--dark-gray); margin-bottom: 15px;">Consent for Media (Photo/Video)</h4>
                            <div class="checkbox-group" style="margin-bottom: 15px;">
                                <label class="checkbox-label" style="display: flex; align-items: flex-start; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="photoVideoPermission" name="photoVideoPermission" style="margin-right: 10px; margin-top: 4px;">
                                    <span style="color: var(--medium-gray); line-height: 1.5;">I give permission for photos and/or videos of my face to be taken during or after my treatment.</span>
                                </label>
                            </div>
                            
                            <p style="color: var(--medium-gray); margin-bottom: 10px; font-weight: 500;">I understand that these images and testimonial(s) may be:</p>
                            <ul style="color: var(--medium-gray); line-height: 1.6; margin-left: 20px; margin-bottom: 15px;">
                                <li>Posted on official social media platforms (Facebook, Instagram, TikTok, etc.).</li>
                                <li>Included in marketing materials, brochures, or presentations.</li>
                                <li>Shown on the company's website or online channels.</li>
                            </ul>
                        </div>

                        <div class="acknowledgement-section" style="margin-bottom: 25px;">
                            <h4 style="color: var(--dark-gray); margin-bottom: 15px;">Acknowledgement</h4>
                            <div class="checkbox-group" style="margin-bottom: 15px;">
                                    <label class="checkbox-label" style="display: flex; align-items: flex-start; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="acknowledgementConsent" name="acknowledgementConsent" style="margin-right: 10px; margin-top: 4px;">
                                    <span style="color: var(--medium-gray); line-height: 1.5;">I acknowledge and agree to all the following terms:</span>
                                </label>
                            </div>
                            <ul style="color: var(--medium-gray); line-height: 1.6; margin-left: 20px;">
                                <li>I confirm that the testimonial reflects my own experience as a patient.</li>
                                <li>I understand that my participation is voluntary.</li>
                                <li>I acknowledge that once my testimonial/photo/video is published online, the clinic cannot fully control third-party sharing.</li>
                                <li>I release Your Company and its staff from any liability related to the use of my testimonial, photos, or videos.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group full-width signature-section">
                        <label>
                            <i class="fas fa-signature icon"></i>
                            Patient Digital Signature
                        </label>
                        <p style="margin-bottom: 15px; color: var(--medium-gray);">I acknowledge that I have read and understood this consent form.</p>
                        <div class="mobile-signature-hint">
                            <i class="fas fa-mobile-alt" style="margin-right: 8px;"></i>
                            <strong>Mobile Tip:</strong> Use your finger to sign. The signature area is optimized for touch.
                        </div>
                        <div class="signature-container" id="patientSignatureContainer">
                            <div class="signature-placeholder" id="patientSignaturePlaceholder">
                                <i class="fas fa-pen-nib" style="font-size: 24px; color: var(--medium-gray); margin-bottom: 8px;"></i>
                                <p>Please sign in the box below</p>
                            </div>
                            <canvas id="patientSignatureCanvas" class="signature-canvas" width="400" height="150"></canvas>
                            <div class="signature-controls">
                                <button type="button" class="btn btn-secondary" onclick="clearPatientSignature()">
                                    <i class="fas fa-eraser"></i>
                                    Clear Signature
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="submitForm()" id="submitBtn">
                    <i class="fas fa-paper-plane"></i>
                    Submit Form
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header" id="modalHeader">
                <h3 id="modalTitle">Form Submission</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let patientSignaturePad;

        function initializeSignaturePads() {
            const patientCanvas = document.getElementById('patientSignatureCanvas');
            
            if (patientCanvas) {
                patientCanvas.style.display = 'block';
                document.querySelector('.signature-controls').style.display = 'flex';
                
                patientSignaturePad = new SignaturePad(patientCanvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: '#2d3748',
                    minWidth: 1,
                    maxWidth: 3,
                    throttle: 16,
                    minDistance: 5
                });

                patientSignaturePad.addEventListener('beginStroke', () => {
                    document.getElementById('patientSignaturePlaceholder').style.display = 'none';
                });

                patientSignaturePad.addEventListener('endStroke', () => {
                    if (patientSignaturePad.isEmpty()) {
                        document.getElementById('patientSignaturePlaceholder').style.display = 'flex';
                    }
                });
            }
        }

        function clearPatientSignature() {
            if (patientSignaturePad) {
                patientSignaturePad.clear();
                document.getElementById('patientSignaturePlaceholder').style.display = 'flex';
            }
        }

        function submitForm() {
            const form = document.getElementById('consentForm');
            const formData = new FormData(form);
            
            const patientName = formData.get('patientName');
            const contactNo = formData.get('contactNo');
            const patientEmail = formData.get('patientEmail');
            const photoVideoPermission = formData.get('photoVideoPermission');
            const acknowledgementConsent = formData.get('acknowledgementConsent');
            

            if (!patientName || !contactNo || !patientEmail) {
                showErrorModal('Validation Error', 'Please fill in your name, contact number, and email address.');
                return;
            }


            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(patientEmail)) {
                showErrorModal('Invalid Email', 'Please enter a valid email address.');
                return;
            }

            if (!photoVideoPermission || !acknowledgementConsent) {
                showErrorModal('Consent Required', 'Please tick both consent checkboxes to proceed.');
                return;
            }

            if (!patientSignaturePad || patientSignaturePad.isEmpty()) {
                showErrorModal('Signature Required', 'Please provide your digital signature before submitting.');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            const submitData = {
                patientName: patientName,
                contactNo: contactNo,
                patientEmail: patientEmail,
                photoVideoPermission: photoVideoPermission === 'on',
                acknowledgementConsent: acknowledgementConsent === 'on',
                patientSignature: patientSignaturePad.toDataURL()
            };

            generateClientPDF(submitData, false, function(pdfBase64) {
                submitData.pdfBase64 = pdfBase64; 
                google.script.run
                  .withSuccessHandler(function(response) {
                      submitBtn.innerHTML = originalText;
                      submitBtn.disabled = false;
                      if (response.success) {
                          showSuccessModal(patientName, submitData);
                          form.reset();
                          clearPatientSignature();
                      } else {
                          showErrorModal('Error', 'There was an error submitting your form. Please try again.');
                      }
                  })
                  .withFailureHandler(function(error) {
                      submitBtn.innerHTML = originalText;
                      submitBtn.disabled = false;
                      showErrorModal('Error', 'There was an error submitting your form: ' + error.message);
                  })
                  .saveTestimonialConsentForm(submitData);
            });
        }

        function showSuccessModal(patientName, formData) {
            const modalHeader = document.getElementById('modalHeader');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modalFooter = document.getElementById('modalFooter');
            
            modalHeader.className = 'modal-header';
            modalTitle.innerHTML = '<i class="fas fa-check-circle"></i> Success!';
            
            modalContent.innerHTML = `
                <div class="success-icon">
                    <i class="fas fa-check"></i>
                </div>
                <p><strong>Thank you, ${patientName}!</strong></p>
                <p>Your testimonial consent form has been submitted successfully. The form data has been saved to our records.</p>
                <p>You can download a PDF copy of your consent form for your records.</p>
            `;
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="btn btn-download" onclick="downloadPDF()">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            `;
            

            window.currentFormData = formData;
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function showErrorModal(title, content) {
            const modalHeader = document.getElementById('modalHeader');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modalFooter = document.getElementById('modalFooter');
            
            modalHeader.className = 'modal-header error';
            modalTitle.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + title;
            modalContent.innerHTML = `<p>${content}</p>`;
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            `;
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function downloadPDF() {
            if (window.currentFormData) {
                generateClientPDF(window.currentFormData);
            }
        }

        function generateClientPDF(formData, download = true, callback) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const margin = 20;
            let yPos = margin;
            const pageWidth = doc.internal.pageSize.getWidth();
            const contentWidth = pageWidth - (margin * 2);
            const imgWidth = 80;
            const imgHeight = 30;

            doc.setFillColor(197, 62, 92);
            doc.rect(0, 0, pageWidth, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Consent Form for Testimonial and Educational Use', pageWidth / 2, 15, { align: 'center' });

            yPos = 50;

            doc.setTextColor(197, 62, 92);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Patient Information', margin, yPos);
            yPos += 10;

            doc.setDrawColor(197, 62, 92);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 15;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Patient Name: ${formData.patientName}`, margin, yPos); yPos += 8;
            doc.text(`Contact No: ${formData.contactNo}`, margin, yPos); yPos += 8;
            doc.text(`Patient Email: ${formData.patientEmail}`, margin, yPos); yPos += 20;

            yPos = addSection(doc, 'Purpose',
                'This consent form is to confirm that I, the undersigned, voluntarily agree to provide my testimonial regarding treatment with K-Laser. I understand that my testimonial may be used by Photomedic Solutions Sdn Bhd for educational, promotional, and marketing purposes.',
                margin, yPos, contentWidth
            );

            if (yPos > 240) { doc.addPage(); yPos = margin; }

            doc.setTextColor(197, 62, 92);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Consent for Media (Photo/Video)', margin, yPos);
            yPos += 8;

            doc.setFillColor(248, 232, 236);
            doc.rect(margin, yPos - 2, contentWidth, 1, 'F');
            yPos += 10;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');

            const boxSize = 5;
            doc.rect(margin, yPos - boxSize + 2, boxSize, boxSize);
            doc.text("Granted", margin + 8, yPos);
            if (formData.photoVideoPermission) {
                drawCheckmark(doc, margin, yPos - boxSize + 2, boxSize);
            }
            yPos += 15;

            if (formData.photoVideoPermission) {
                const mediaDetails = [
                    "I give permission for photos and/or videos of my face to be taken during or after my treatment.",
                    "I understand that these images and testimonial(s) may be:",
                    "• Posted on official social media platforms (Facebook, Instagram, TikTok, etc.)",
                    "• Included in marketing materials, brochures, or presentations",
                    "• Shown on the company's website or online channels"
                ];
                mediaDetails.forEach(text => {
                    const lines = doc.splitTextToSize(text, contentWidth);
                    lines.forEach(line => {
                        if (yPos > 270) { doc.addPage(); yPos = margin; }
                        doc.text(line, margin + 2, yPos);
                        yPos += 5;
                    });
                    yPos += 3;
                });
            }

            const ackText = `• I confirm that the testimonial reflects my own experience as a patient.
        • I understand that my participation is voluntary.
        • I acknowledge that once my testimonial/photo/video is published online, the clinic cannot fully control third-party sharing.
        • I release Photomedic Solutions Sdn Bhd and its staff from any liability related to the use of my testimonial, photos, or videos.`;
            yPos = addSection(doc, 'Acknowledgement', ackText, margin, yPos, contentWidth);

            if (yPos > 200) { doc.addPage(); yPos = margin; }
            doc.setTextColor(197, 62, 92);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Signature', margin, yPos);
            yPos += 10;

            doc.setDrawColor(197, 62, 92);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 15;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.text(`Patient Signature: [Recorded on ${new Date().toLocaleDateString()}]`, margin, yPos);
            yPos += 10;

            if (formData.patientSignature) {
                try {
                    doc.addImage(formData.patientSignature, 'PNG', margin, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 5;
                } catch (e) {
                    doc.text("[Signature image could not be added]", margin, yPos);
                    yPos += 20;
                }
            } else {
                doc.text("[No patient signature provided]", margin, yPos);
                yPos += 20;
            }

            doc.text(`Patient Name: ${formData.patientName}`, margin, yPos); yPos += 6;
            doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, yPos);

            const footerY = doc.internal.pageSize.getHeight() - 10;
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text('Generated on ' + new Date().toLocaleString(), pageWidth / 2, footerY, { align: 'center' });

            if (download) {
                doc.save(`Testimonial_Consent_${formData.patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            }
            if (callback) {
                const pdfBase64 = doc.output("datauristring").split(",")[1];
                callback(pdfBase64);
            }

            function addSection(doc, title, content, margin, yPos, contentWidth) {
                if (yPos > 240) { doc.addPage(); yPos = margin; }
                doc.setTextColor(197, 62, 92);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(title, margin, yPos);
                yPos += 8;
                doc.setFillColor(248, 232, 236);
                doc.rect(margin, yPos - 2, contentWidth, 1, 'F');
                yPos += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const lines = doc.splitTextToSize(content, contentWidth);
                lines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = margin;
                    }
                    doc.text(line, margin + 2, yPos);
                    yPos += 5;
                });
                return yPos + 10;
            }

            function drawCheckmark(doc, x, y, boxSize) {
                const offset = 1.5;
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.6);
                doc.line(x + offset, y + 1, x + boxSize / 2, y + boxSize - offset);
                doc.line(x + boxSize / 2, y + boxSize - offset, x + boxSize - offset, y - 1);
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        class SignaturePad {
            constructor(canvas, options = {}) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.options = {
                    backgroundColor: options.backgroundColor || 'rgba(255, 255, 255, 0)',
                    penColor: options.penColor || '#000',
                    minWidth: options.minWidth || 0.5,
                    maxWidth: options.maxWidth || 2.5,
                    throttle: options.throttle || 16,
                    minDistance: options.minDistance || 5
                };
                
                this.drawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this._isEmpty = true;
                this.events = {};
                
                this.setupCanvas();
                this.bindEvents();
            }
            
            setupCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                this.canvas.width = this.canvas.offsetWidth * ratio;
                this.canvas.height = this.canvas.offsetHeight * ratio;
                this.canvas.getContext('2d').scale(ratio, ratio);
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
            }
            
            bindEvents() {
                this.canvas.addEventListener('mousedown', this.handleStart.bind(this));
                this.canvas.addEventListener('mousemove', this.handleMove.bind(this));
                this.canvas.addEventListener('mouseup', this.handleEnd.bind(this));
                this.canvas.addEventListener('touchstart', this.handleStart.bind(this));
                this.canvas.addEventListener('touchmove', this.handleMove.bind(this));
                this.canvas.addEventListener('touchend', this.handleEnd.bind(this));
            }
            
            handleStart(e) {
                e.preventDefault();
                this.drawing = true;
                const point = this.getPoint(e);
                this.lastX = point.x;
                this.lastY = point.y;
                this.triggerEvent('beginStroke');
            }
            
            handleMove(e) {
                if (!this.drawing) return;
                e.preventDefault();
                
                const point = this.getPoint(e);
                this.ctx.strokeStyle = this.options.penColor;
                this.ctx.lineWidth = this.options.maxWidth;
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(point.x, point.y);
                this.ctx.stroke();
                
                this.lastX = point.x;
                this.lastY = point.y;
                this._isEmpty = false;
            }
            
            handleEnd(e) {
                if (!this.drawing) return;
                e.preventDefault();
                this.drawing = false;
                this.triggerEvent('endStroke');
            }
            
            getPoint(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }
            
            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this._isEmpty = true;
            }
            
            isEmpty() {
                return this._isEmpty;
            }
            
            toDataURL(type = 'image/png') {
                return this.canvas.toDataURL(type);
            }
            
            addEventListener(event, callback) {
                if (!this.events[event]) {
                    this.events[event] = [];
                }
                this.events[event].push(callback);
            }
            
            triggerEvent(event) {
                if (this.events[event]) {
                    this.events[event].forEach(callback => callback());
                }
            }
        }

        window.onload = initializeSignaturePads;
    </script>
</body>
</html>
